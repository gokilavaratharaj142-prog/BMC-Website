<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - Best Marketing Company</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>window.API_BASE="http://localhost:5000";</script>
<style>
:root{--bg:#f9f5eb;--surface:#fff;--text:#3e2723;--text-light:#6d4c41;--accent:#8d6e63;--accent-dark:#4e342e;--border:rgba(62,39,35,.1)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);font-family:'Manrope',sans-serif;color:var(--text);min-height:100vh}

/* Layout */
.dash-wrap{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:20px 0;flex-shrink:0}
.sidebar-item{display:block;padding:12px 20px;color:var(--text);font-size:14px;font-weight:500;text-decoration:none;transition:background .2s}
.sidebar-item:hover{background:rgba(141,110,99,.08)}
.sidebar-item.active{background:rgba(141,110,99,.12);color:var(--accent-dark);border-left:3px solid var(--accent);margin-left:-3px;padding-left:23px}

.main{flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(62,39,35,.06)}
.topbar-left{font-size:16px;font-weight:600;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:16px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.ok{background:#1b6d2f}
.status-dot.bad{background:#b00020}
.status-text{font-size:12px;color:var(--text-light)}
.btn-out{font-size:13px;padding:8px 14px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;cursor:pointer;font-weight:500;transition:all .2s}
.btn-out:hover{background:rgba(62,39,35,.06)}

.content{padding:24px;flex:1}
.page-title{font-size:22px;font-weight:700;margin-bottom:4px;letter-spacing:-0.02em}
.page-desc{font-size:14px;color:var(--text-light);margin-bottom:24px}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04);transition:all .3s ease;position:relative;overflow:hidden}
.card:hover{box-shadow:0 6px 16px rgba(62,39,35,.12);transform:translateY(-4px)}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--card-accent,#8d6e63)}
.card.blue{--card-accent:#8d6e63}
.card.purple{--card-accent:#8d6e63}
.card.gold{--card-accent:#8d6e63}
.card.green{--card-accent:#8d6e63}
.card-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);font-weight:600;margin-bottom:6px}
.card-value{font-size:32px;font-weight:800;color:var(--accent-dark);line-height:1.1;font-variant-numeric:tabular-nums}
.card-trend{font-size:12px;color:var(--text-light);margin-top:8px}
.trend-up{color:var(--text-light)}
.trend-down{color:var(--text-light)}

/* Charts */
.charts-row{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04)}
.chart-title{font-size:14px;font-weight:700;margin-bottom:16px;color:var(--text)}

/* Activity */
.activity-item{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg);border-radius:8px;transition:background .2s;position:relative}
.activity-item:hover{background:rgba(141,110,99,.08)}
.activity-item.new-glow{animation:newGlow 3s ease-out forwards}
@keyframes newGlow{0%{background:rgba(59,130,246,.15);box-shadow:0 0 12px rgba(59,130,246,.3)}100%{background:var(--bg);box-shadow:none}}
.activity-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.activity-icon.contact{background:#dbeafe;color:#3b82f6}
.activity-icon.feedback{background:#ede9fe;color:#8b5cf6}
.activity-icon.product{background:#dcfce7;color:#10b981}
.activity-content{flex:1;min-width:0}
.activity-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:2px}
.activity-meta{font-size:11px;color:var(--text-light);margin-bottom:6px}
.activity-actions{display:flex;gap:6px;margin-top:6px}
.btn-email{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;transition:all .2s;box-shadow:0 2px 4px rgba(59,130,246,.2)}
.btn-email:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(59,130,246,.3)}
.enquiry-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-left:6px}
.enquiry-badge.product{background:#dcfce7;color:#166534}
.enquiry-badge.general{background:#e0e7ff;color:#3730a3}

/* Loading Skeleton */
.skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{height:100px;border-radius:10px}
.skeleton-chart{height:300px;border-radius:10px}

/* Engagement Mini Cards */
.engagement-mini{background:var(--bg);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px;transition:all .2s}
.engagement-mini:hover{background:rgba(141,110,99,.08);transform:translateX(4px)}
.engagement-mini-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.engagement-mini-icon.whatsapp{background:#dcfce7;color:#16a34a}
.engagement-mini-icon.call{background:#dbeafe;color:#3b82f6}
.engagement-mini-icon.email{background:#fef3c7;color:#d97706}
.engagement-mini-icon.chat{background:#ede9fe;color:#8b5cf6}
.engagement-mini-content{flex:1}
.engagement-mini-label{font-size:11px;color:var(--text-light);margin-bottom:2px}
.engagement-mini-value{font-size:18px;font-weight:700;color:var(--accent-dark)}

/* Business Analytics Section */
.analytics-section{background:linear-gradient(135deg,rgba(141,110,99,.05),rgba(141,110,99,.02));border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:32px;animation:fadeIn .6s ease}
.analytics-header{margin-bottom:24px}
.analytics-title{font-size:20px;font-weight:700;color:var(--text);margin-bottom:4px;letter-spacing:-0.02em}
.analytics-subtitle{font-size:13px;color:var(--text-light)}

/* Business KPI Cards */
.business-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.business-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;position:relative;overflow:hidden;transition:all .3s ease;box-shadow:0 2px 8px rgba(62,39,35,.04)}
.business-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(62,39,35,.12)}
.business-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--kpi-color,var(--accent))}
.business-card.revenue{--kpi-color:#8d6e63}
.business-card.expense{--kpi-color:#8d6e63}
.business-card.profit{--kpi-color:#8d6e63}
.business-card.growth{--kpi-color:#8d6e63}
.kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);font-weight:600;margin-bottom:8px}
.kpi-value{font-size:36px;font-weight:800;color:var(--accent-dark);line-height:1;margin-bottom:8px;font-variant-numeric:tabular-nums}
.kpi-trend{display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:4px;color:var(--text-light)}
.kpi-trend.up{color:var(--text-light)}
.kpi-trend.down{color:var(--text-light)}
.kpi-sublabel{font-size:11px;color:var(--text-light)}

/* Analytics Charts Grid */
.analytics-charts{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
.analytics-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04);animation:fadeIn .8s ease}
.analytics-chart-title{font-size:15px;font-weight:700;margin-bottom:16px;color:var(--text)}

/* Profit Loss Chart */
.profit-loss-section{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}

/* Engagement Cards Grid */
.engagement-cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.engagement-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;transition:all .2s;box-shadow:0 1px 3px rgba(62,39,35,.04)}
.engagement-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(62,39,35,.08)}
.engagement-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.engagement-card-icon{font-size:24px}
.engagement-card-value{font-size:28px;font-weight:800;color:var(--accent-dark);line-height:1}
.engagement-card-label{font-size:11px;color:var(--text-light);text-transform:uppercase;letter-spacing:.05em;font-weight:600;margin-top:4px}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:1200px){.business-kpis{grid-template-columns:repeat(2,1fr)}.analytics-charts{grid-template-columns:1fr}.profit-loss-section{grid-template-columns:1fr}}
@media(max-width:768px){.business-kpis{grid-template-columns:1fr}}

/* Tabs & Tools */
.tabs{display:flex;gap:8px;margin-bottom:16px}
.tab{padding:10px 18px;border:1px solid var(--border);border-radius:8px;background:var(--surface);cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.tab:hover{background:rgba(141,110,99,.06)}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.tools{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:center}
.search-wrap{flex:1;min-width:200px;max-width:320px}
.search-wrap input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--surface)}
.search-wrap input:focus{outline:none;border-color:var(--accent)}
.btn{padding:10px 16px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.btn:hover{background:var(--accent-dark);border-color:var(--accent-dark)}
.btn.secondary{background:transparent;color:var(--text);border-color:var(--border)}
.btn.secondary:hover{background:rgba(62,39,35,.06)}

/* Panel & Table */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 8px rgba(62,39,35,.04);overflow:hidden}
.table-wrap{overflow-x:auto}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th{background:rgba(62,39,35,.04);padding:12px 16px;text-align:left;font-weight:600;color:var(--text)}
.table td{padding:12px 16px;border-top:1px solid var(--border)}
.table tr:hover{background:rgba(141,110,99,.04)}
.empty{padding:32px;text-align:center;color:var(--text-light);font-size:14px}

/* Charts */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04)}
.chart-title{font-size:14px;font-weight:700;margin-bottom:16px;color:var(--text)}
.bar-chart{display:flex;flex-direction:column;gap:12px}
.bar-row{display:flex;align-items:center;gap:12px}
.bar-label{width:100px;font-size:12px;font-weight:500;color:var(--text-light)}
.bar-track{flex:1;height:8px;background:rgba(62,39,35,.08);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .3s}
.bar-val{width:36px;text-align:right;font-size:12px;font-weight:600;color:var(--text-light)}
.line-chart-svg{width:100%;height:120px}

/* Pagination */
.pagination{display:flex;gap:6px;align-items:center;margin-top:16px;flex-wrap:wrap}
.pagination button{padding:8px 12px;border:1px solid var(--border);background:var(--surface);border-radius:6px;cursor:pointer;font-size:13px;font-weight:500}
.pagination button:hover:not(:disabled){background:rgba(141,110,99,.08)}
.pagination button:disabled{opacity:0.5;cursor:not-allowed}
.pagination .page-info{font-size:13px;color:var(--text-light);margin-left:8px}

@media(max-width:1024px){.cards{grid-template-columns:1fr 1fr}.charts-row{grid-template-columns:1fr}}
@media(max-width:768px){.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border)}.dash-wrap{flex-direction:column}.cards{grid-template-columns:1fr}.tools{flex-direction:column;align-items:stretch}.charts-row{grid-template-columns:1fr}}

/* Dark Mode */
body.dark-mode{--bg:#1a1a1a;--surface:#2d2d2d;--text:#e5e5e5;--text-light:#a3a3a3;--accent:#a78bfa;--accent-dark:#c4b5fd;--border:rgba(255,255,255,.1)}
body.dark-mode .card::before{opacity:0.8}
body.dark-mode .activity-icon.contact{background:#1e3a8a;color:#93c5fd}
body.dark-mode .activity-icon.feedback{background:#4c1d95;color:#c4b5fd}
body.dark-mode .activity-icon.product{background:#14532d;color:#86efac}
body.dark-mode .engagement-mini-icon.whatsapp{background:#14532d;color:#86efac}
body.dark-mode .engagement-mini-icon.call{background:#1e3a8a;color:#93c5fd}
body.dark-mode .engagement-mini-icon.email{background:#78350f;color:#fcd34d}
body.dark-mode .engagement-mini-icon.chat{background:#4c1d95;color:#c4b5fd}
body.dark-mode .skeleton{background:linear-gradient(90deg,#2d2d2d 25%,#3d3d3d 50%,#2d2d2d 75%)}

/* Button Ripple Effect */
.btn,.modal-btn,.tab{position:relative;overflow:hidden}
.btn::after,.modal-btn::after,.tab::after{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.5);transform:translate(-50%,-50%);transition:width .4s,height .4s}
.btn:active::after,.modal-btn:active::after,.tab:active::after{width:200px;height:200px}
</style>
</head>
<body>
<div class="dash-wrap">
  <aside class="sidebar">
    <a href="#" class="sidebar-item active" data-nav="dashboard">Dashboard</a>
    <a href="#" class="sidebar-item" data-nav="contacts">Contacts</a>
    <a href="#" class="sidebar-item" data-nav="feedback">Feedback</a>
    <a href="#" class="sidebar-item" data-nav="analytics">Analytics</a>
  </aside>
  <main class="main">
    <header class="topbar">
      <div class="topbar-left">
        <div style="display:flex;flex-direction:column;gap:2px">
          <div style="font-size:16px;font-weight:600;color:var(--text)">Welcome back, <span id="adminName">Admin</span></div>
          <div style="font-size:11px;color:var(--text-light)">Last login: <span id="lastLogin">Loading...</span> ‚Ä¢ Active sessions: <span id="activeSessions">0</span></div>
        </div>
      </div>
      <div class="topbar-right">
        <button type="button" class="btn-out" id="darkModeToggle" title="Toggle Dark Mode" style="padding:8px 10px">üåô</button>
        <span class="status-text"><span id="statusDot" class="status-dot"></span><span id="backendStatus">Checking...</span></span>
        <button type="button" class="btn-out" id="logoutBtn">Logout</button>
      </div>
    </header>
    <div class="content">
      <h1 class="page-title">Dashboard</h1>
      <p class="page-desc" id="pageDesc">Overview of contacts and feedback</p>

      <!-- Business Performance Analytics -->
      <div class="analytics-section">
        <div class="analytics-header">
          <h2 class="analytics-title">Business Performance Overview</h2>
          <p class="analytics-subtitle">Last 12 Months Performance Analysis</p>
        </div>

        <!-- Business KPI Cards -->
        <div class="business-kpis">
          <div class="business-card revenue">
            <div class="kpi-label">Total Revenue</div>
            <div class="kpi-value" id="kpiRevenue" data-target="4850000">‚Çπ0</div>
            <div class="kpi-trend up">
              <span>+18.4% vs last year</span>
            </div>
            <div class="kpi-sublabel">Last 12 Months</div>
          </div>
          <div class="business-card expense">
            <div class="kpi-label">Total Expenses</div>
            <div class="kpi-value" id="kpiExpense" data-target="3120000">‚Çπ0</div>
            <div class="kpi-trend up">
              <span>+12.1% vs last year</span>
            </div>
            <div class="kpi-sublabel">Last 12 Months</div>
          </div>
          <div class="business-card profit">
            <div class="kpi-label">Net Profit</div>
            <div class="kpi-value" id="kpiProfit" data-target="1730000">‚Çπ0</div>
            <div class="kpi-trend up">
              <span>+24.8% vs last year</span>
            </div>
            <div class="kpi-sublabel">Last 12 Months</div>
          </div>
          <div class="business-card growth">
            <div class="kpi-label">Growth Rate</div>
            <div class="kpi-value" id="kpiGrowth" data-target="18.4">0%</div>
            <div class="kpi-trend up">
              <span>+6.3% improvement</span>
            </div>
            <div class="kpi-sublabel">Year over Year</div>
          </div>
        </div>

        <!-- Analytics Charts Row 1 -->
        <div class="analytics-charts">
          <div class="analytics-chart-card">
            <h3 class="analytics-chart-title">Monthly Revenue (Last Year)</h3>
            <canvas id="monthlyRevenueChart"></canvas>
          </div>
          <div class="analytics-chart-card">
            <h3 class="analytics-chart-title">Revenue Distribution by Category</h3>
            <canvas id="revenueDistChart"></canvas>
          </div>
        </div>

        <!-- Profit Loss Chart -->
        <div class="profit-loss-section">
          <div class="analytics-chart-card">
            <h3 class="analytics-chart-title">Profit vs Expenses Trend</h3>
            <canvas id="profitLossChart"></canvas>
          </div>
          <div class="analytics-chart-card">
            <h3 class="analytics-chart-title">Customer Engagement Overview</h3>
            <div class="engagement-cards-grid">
              <div class="engagement-card">
                <div class="engagement-card-header">
                  <span class="engagement-card-icon">üí¨</span>
                </div>
                <div class="engagement-card-value" id="engWhatsapp">0</div>
                <div class="engagement-card-label">WhatsApp</div>
              </div>
              <div class="engagement-card">
                <div class="engagement-card-header">
                  <span class="engagement-card-icon">üìû</span>
                </div>
                <div class="engagement-card-value" id="engCalls">0</div>
                <div class="engagement-card-label">Calls</div>
              </div>
              <div class="engagement-card">
                <div class="engagement-card-header">
                  <span class="engagement-card-icon">‚úâÔ∏è</span>
                </div>
                <div class="engagement-card-value" id="engEmail">0</div>
                <div class="engagement-card-label">Email</div>
              </div>
              <div class="engagement-card">
                <div class="engagement-card-header">
                  <span class="engagement-card-icon">üí¨</span>
                </div>
                <div class="engagement-card-value" id="engChat">0</div>
                <div class="engagement-card-label">Chat</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="cards">
        <div class="card blue">
          <div class="card-label">Total Contacts</div>
          <div class="card-value" id="stContacts" data-target="0">0</div>
          <div class="card-trend" id="contactTrend"></div>
        </div>
        <div class="card purple">
          <div class="card-label">Total Feedback</div>
          <div class="card-value" id="stFeedback" data-target="0">0</div>
          <div class="card-trend" id="feedbackTrend"></div>
        </div>
        <div class="card gold">
          <div class="card-label">Average Rating</div>
          <div class="card-value" id="stAvgRating" data-target="0">0.0</div>
          <div class="card-trend">‚≠ê Out of 5.0</div>
        </div>
        <div class="card green">
          <div class="card-label">New Enquiries Today</div>
          <div class="card-value" id="stNewToday" data-target="0">0</div>
          <div class="card-trend" id="newTodayTrend"></div>
        </div>
        <div class="card" style="--card-accent:#8d6e63">
          <div class="card-label">Pending Responses</div>
          <div class="card-value" id="stPending" data-target="0">0</div>
          <div class="card-trend">Needs attention</div>
        </div>
        <div class="card" style="--card-accent:#8d6e63">
          <div class="card-label">Product Enquiries</div>
          <div class="card-value" id="stProductEnq" data-target="0">0</div>
          <div class="card-trend" id="productEnqTrend"></div>
        </div>
      </div>

      <!-- Analytics Charts -->
      <div class="charts-row" style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px">
        <div class="chart-card">
          <h3 class="chart-title">Feedback Trend</h3>
          <canvas id="feedbackChart"></canvas>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">Rating Distribution</h3>
          <canvas id="ratingChart"></canvas>
        </div>
      </div>

      <!-- Recent Activity & Engagement -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px">
        <div class="activity-panel" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:16px">Recent Activity</h3>
          <div id="recentActivity" style="display:grid;gap:12px"></div>
        </div>
        <div class="engagement-panel" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:16px">Engagement Tracking</h3>
          <div id="engagementStats" style="display:grid;gap:10px"></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="contacts" type="button">Contacts</button>
        <button class="tab" data-tab="feedback" type="button">Feedback</button>
      </div>

      <div class="tools">
        <div class="search-wrap"><input type="text" id="searchInput" placeholder="Search..." /></div>
        <button class="btn" id="exportCsv" type="button">Export CSV</button>
        <button class="btn" id="exportXlsx" type="button">Export Excel</button>
        <button class="btn" id="exportPdf" type="button">Export PDF</button>
        <button class="btn secondary" id="clearRecords" type="button">Clear Records</button>
      </div>

      <div class="panel">
        <div class="table-wrap" id="tableWrap"></div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </main>
</div>

<script>
const API_BASE = window.API_BASE || 'http://localhost:5000';
const TOKEN_KEY = 'bmc_jwt';
const AUTH_KEY = 'bmc_admin_auth';
const PAGE_SIZE = 10;

let current = 'contacts';
let rowsContacts = [];
let rowsFeedback = [];
let filteredContacts = [];
let filteredFeedback = [];
let currentPage = 1;
let searchQuery = '';

const q = (id) => document.getElementById(id);
const esc = (v) => String(v ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function logoutLocal() {
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(AUTH_KEY);
  window.location.href = 'admin.html';
}

function authHeaders() {
  const token = localStorage.getItem(TOKEN_KEY) || '';
  return token ? { Authorization: `Bearer ${token}` } : {};
}

async function apiGet(path) {
  const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders() }).catch(()=>null);
  if(!res) return { ok:false, status:0, data:null };
  const data = await res.json().catch(()=>null);
  return { ok: res.ok, status: res.status, data };
}

async function apiPost(path, body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeaders() },
    body: JSON.stringify(body || {})
  }).catch(()=>null);
  if(!res) return { ok:false, status:0, data:null };
  const data = await res.json().catch(()=>null);
  return { ok: res.ok, status: res.status, data };
}

function toCSV(rows) {
  if(!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const e = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;
  return [cols.join(',')].concat(rows.map(r => cols.map(c => e(r[c])).join(','))).join('\r\n');
}

function dateOf(row) { return new Date(row.createdAt || row.timestamp || Date.now()); }
function monthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

function filterRows(rows, q) {
  if(!q.trim()) return rows;
  const lower = q.toLowerCase();
  return rows.filter(r => Object.values(r).some(v => String(v ?? '').toLowerCase().includes(lower)));
}

function isTokenExpired() {
  const token = localStorage.getItem(TOKEN_KEY);
  if(!token) return true;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.exp && payload.exp * 1000 < Date.now();
  } catch(_){ return true; }
}

function animateBusinessKPIs() {
  // Animate revenue
  const revenueEl = document.getElementById('kpiRevenue');
  if(revenueEl) {
    const target = 4850000;
    animateValueCustom(revenueEl, 0, target, 1500, (val) => {
      return '‚Çπ' + formatIndianCurrency(Math.round(val));
    });
  }
  
  // Animate expense
  const expenseEl = document.getElementById('kpiExpense');
  if(expenseEl) {
    const target = 3120000;
    animateValueCustom(expenseEl, 0, target, 1500, (val) => {
      return '‚Çπ' + formatIndianCurrency(Math.round(val));
    });
  }
  
  // Animate profit
  const profitEl = document.getElementById('kpiProfit');
  if(profitEl) {
    const target = 1730000;
    animateValueCustom(profitEl, 0, target, 1500, (val) => {
      return '‚Çπ' + formatIndianCurrency(Math.round(val));
    });
  }
  
  // Animate growth
  const growthEl = document.getElementById('kpiGrowth');
  if(growthEl) {
    animateValueCustom(growthEl, 0, 18.4, 1500, (val) => {
      return val.toFixed(1) + '%';
    });
  }
  
  // Animate engagement cards
  setTimeout(() => {
    animateValue('engWhatsapp', 0, 120, 1000);
    animateValue('engCalls', 0, 85, 1000);
    animateValue('engEmail', 0, 60, 1000);
    animateValue('engChat', 0, 45, 1000);
  }, 300);
  
  // Render business charts
  renderBusinessCharts();
}

function formatIndianCurrency(num) {
  if(num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
  if(num >= 100000) return (num / 100000).toFixed(2) + ' L';
  if(num >= 1000) return (num / 1000).toFixed(2) + ' K';
  return num.toString();
}

function animateValueCustom(el, start, end, duration, formatter) {
  const range = end - start;
  const increment = range / (duration / 16);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
      current = end;
      clearInterval(timer);
    }
    el.textContent = formatter(current);
  }, 16);
}

function renderBusinessCharts() {
  // Monthly Revenue Bar Chart
  const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart');
  if(monthlyRevenueCtx) {
    if(monthlyRevenueChartInstance) monthlyRevenueChartInstance.destroy();
    
    const monthlyData = [3.2, 3.5, 4.1, 3.8, 4.5, 4.9, 5.2, 4.7, 5.5, 5.8, 6.2, 6.9];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    monthlyRevenueChartInstance = new Chart(monthlyRevenueCtx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Revenue (‚Çπ Lakhs)',
          data: monthlyData,
          backgroundColor: 'rgba(141, 110, 99, 0.8)',
          borderColor: '#8d6e63',
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.9)',
            padding: 12,
            cornerRadius: 6,
            titleFont: { size: 13, weight: '600' },
            bodyFont: { size: 12 }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => '‚Çπ' + value + 'L',
              font: { size: 11 }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            grid: { display: false },
            ticks: { font: { size: 11 } }
          }
        }
      }
    });
  }
  
  // Revenue Distribution Pie Chart
  const revenueDistCtx = document.getElementById('revenueDistChart');
  if(revenueDistCtx) {
    if(revenueDistChartInstance) revenueDistChartInstance.destroy();
    
    revenueDistChartInstance = new Chart(revenueDistCtx, {
      type: 'doughnut',
      data: {
        labels: ['Valves', 'Crucibles', 'Automation', 'Casting Systems', 'Lubricants'],
        datasets: [{
          data: [35, 20, 18, 15, 12],
          backgroundColor: [
            '#8d6e63',
            '#a1887f',
            '#bcaaa4',
            '#d7ccc8',
            '#efebe9'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              padding: 10,
              font: { size: 11 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.9)',
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: (context) => {
                return context.label + ': ' + context.parsed + '%';
              }
            }
          }
        }
      }
    });
  }
  
  // Profit vs Expenses Line Chart
  const profitLossCtx = document.getElementById('profitLossChart');
  if(profitLossCtx) {
    if(profitLossChartInstance) profitLossChartInstance.destroy();
    
    const revenueData = [3.2, 3.5, 4.1, 3.8, 4.5, 4.9, 5.2, 4.7, 5.5, 5.8, 6.2, 6.9];
    const expenseData = [2.1, 2.3, 2.7, 2.5, 2.9, 3.2, 3.4, 3.1, 3.6, 3.8, 4.0, 4.5];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    profitLossChartInstance = new Chart(profitLossCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Revenue',
            data: revenueData,
            borderColor: '#8d6e63',
            backgroundColor: 'rgba(141, 110, 99, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
          },
          {
            label: 'Expenses',
            data: expenseData,
            borderColor: '#a1887f',
            backgroundColor: 'rgba(161, 136, 127, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 10,
              font: { size: 11 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.9)',
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: (context) => {
                return context.dataset.label + ': ‚Çπ' + context.parsed.y + 'L';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => '‚Çπ' + value + 'L',
              font: { size: 11 }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            grid: { display: false },
            ticks: { font: { size: 11 } }
          }
        }
      }
    });
  }
}

async function loadData() {
  const token = localStorage.getItem(TOKEN_KEY);
  const authed = localStorage.getItem(AUTH_KEY) === 'yes';
  if(!token || !authed || isTokenExpired()) return logoutLocal();

  // Show loading skeleton
  showLoadingSkeleton();

  const statusEl = q('backendStatus');
  const dotEl = q('statusDot');
  const overview = await apiGet('/api/admin/overview');
  if(!overview.ok) {
    statusEl.textContent = 'Offline';
    dotEl.className = 'status-dot bad';
    if(overview.status === 401 || overview.status === 403) return logoutLocal();
  } else {
    statusEl.textContent = 'Online';
    dotEl.className = 'status-dot ok';
    
    // Update admin info
    if(overview.data && overview.data.user) {
      const user = overview.data.user;
      q('adminName').textContent = user.role === 'super_admin' ? 'Super Admin' : user.username || 'Admin';
      
      // Last login
      if(user.lastActive) {
        const lastLogin = new Date(user.lastActive);
        q('lastLogin').textContent = formatTimeAgo(lastLogin);
      }
      
      // Active sessions
      if(overview.data.activeSessions !== undefined) {
        q('activeSessions').textContent = overview.data.activeSessions;
      }
    }
  }

  const leads = await apiGet('/api/admin/leads');
  const feedback = await apiGet('/api/feedback');
  const engagement = await apiGet('/api/engagement/stats');

  rowsContacts = (leads.ok && Array.isArray(leads.data)) ? leads.data : [];
  rowsFeedback = (feedback.ok && Array.isArray(feedback.data)) ? feedback.data : [];

  applyFilter();
  renderStats();
  renderTable();
  renderCharts();
  renderEngagementStats(engagement.ok ? engagement.data : null);
  
  hideLoadingSkeleton();
}

function showLoadingSkeleton() {
  const cards = document.querySelector('.cards');
  if(cards) cards.style.opacity = '0.5';
}

function hideLoadingSkeleton() {
  const cards = document.querySelector('.cards');
  if(cards) cards.style.opacity = '1';
}

function applyFilter() {
  filteredContacts = filterRows(rowsContacts, searchQuery);
  filteredFeedback = filterRows(rowsFeedback, searchQuery);
  currentPage = 1;
}

function renderStats() {
  // Animate Business KPIs first
  animateBusinessKPIs();
  
  // Count-up animation
  animateValue('stContacts', 0, rowsContacts.length, 1000);
  animateValue('stFeedback', 0, rowsFeedback.length, 1000);

  const now = new Date();
  const curr = monthKey(now);
  const prev = monthKey(new Date(now.getFullYear(), now.getMonth() - 1, 1));
  const currCount = rowsContacts.filter(r => monthKey(dateOf(r)) === curr).length + rowsFeedback.filter(r => monthKey(dateOf(r)) === curr).length;
  const prevCount = rowsContacts.filter(r => monthKey(dateOf(r)) === prev).length + rowsFeedback.filter(r => monthKey(dateOf(r)) === prev).length;
  const growth = prevCount ? Math.round(((currCount - prevCount) / prevCount) * 100) : (currCount ? 100 : 0);

  // New enquiries today
  const today = new Date().toDateString();
  const newToday = rowsContacts.filter(r => new Date(r.createdAt).toDateString() === today).length;
  animateValue('stNewToday', 0, newToday, 1000);
  
  // Pending responses (status = 'new')
  const pending = rowsContacts.filter(r => r.status === 'new').length;
  animateValue('stPending', 0, pending, 1000);
  
  // Product enquiries
  const productEnq = rowsContacts.filter(r => r.enquiryType === 'Product Enquiry').length;
  animateValue('stProductEnq', 0, productEnq, 1000);
  
  const productPercent = rowsContacts.length ? Math.round((productEnq / rowsContacts.length) * 100) : 0;
  const productTrend = document.getElementById('productEnqTrend');
  if(productTrend) {
    productTrend.textContent = `${productPercent}% of total`;
  }

  // Average rating
  const totalStars = rowsFeedback.reduce((sum, r) => sum + (Number(r.stars) || 0), 0);
  const avgRating = rowsFeedback.length ? (totalStars / rowsFeedback.length).toFixed(1) : 0;
  animateValue('stAvgRating', 0, parseFloat(avgRating), 1000, '', true);

  const good = rowsFeedback.filter(r => {
    const rating = String(r.rating || '');
    const stars = Number(r.stars || r.rating || 0);
    return rating.startsWith('5') || rating.startsWith('4') || stars >= 4 || ['love','like','happy'].includes(String(r.sentiment || '').toLowerCase());
  }).length;
  
  renderRecentActivity();
  renderAnalyticsCharts();
}

function animateValue(id, start, end, duration, suffix = '', isDecimal = false) {
  const el = document.getElementById(id);
  if (!el) return;
  
  const range = end - start;
  const increment = range / (duration / 16);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
      current = end;
      clearInterval(timer);
    }
    el.textContent = (isDecimal ? current.toFixed(1) : Math.round(current)) + suffix;
  }, 16);
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');
  if (!container) return;
  
  const allItems = [
    ...rowsContacts.map(r => ({ ...r, type: 'contact' })),
    ...rowsFeedback.map(r => ({ ...r, type: 'feedback' }))
  ].sort((a, b) => dateOf(b) - dateOf(a)).slice(0, 5);
  
  const today = new Date().toDateString();
  
  container.innerHTML = allItems.map(item => {
    const isContact = item.type === 'contact';
    const isNew = new Date(item.createdAt || item.timestamp).toDateString() === today;
    
    if(isContact) {
      const isProduct = item.enquiryType === 'Product Enquiry';
      const icon = isProduct ? 'üõçÔ∏è' : 'üìß';
      const iconClass = isProduct ? 'product' : 'contact';
      const title = isProduct ? 'New Product Enquiry Received' : 'New General Enquiry Received';
      const subtitle = isProduct ? 'Customer is requesting product information' : 'Customer sent a message';
      const time = formatTimeAgo(dateOf(item));
      const badge = `<span class="enquiry-badge ${isProduct ? 'product' : 'general'}">${item.enquiryType}</span>`;
      
      // Email template
      const emailSubject = encodeURIComponent(`Re: Your enquiry at Best Marketing Company`);
      const emailBody = encodeURIComponent(`Dear ${item.name},\n\nThank you for contacting Best Marketing Company.\n\nWe have received your ${item.enquiryType.toLowerCase()} and our team will respond to you shortly.\n\nYour enquiry:\n${item.message}\n\nBest regards,\nBest Marketing Company\nPhone: +91 9095195647\nEmail: gokilavaratharaj142@gmail.com`);
      const mailtoLink = `mailto:${item.email}?subject=${emailSubject}&body=${emailBody}`;
      
      return `<div class="activity-item ${isNew ? 'new-glow' : ''}">
        <div class="activity-icon ${iconClass}">${icon}</div>
        <div class="activity-content">
          <div class="activity-title">${title}${badge}</div>
          <div class="activity-meta">${item.name} ‚Ä¢ ${item.company || 'No company'} ‚Ä¢ ${time}</div>
          <div class="activity-actions">
            <a href="${mailtoLink}" class="btn-email">‚úâÔ∏è Open Email</a>
          </div>
        </div>
      </div>`;
    } else {
      const icon = '‚≠ê';
      const title = `${item.stars}-star feedback from ${item.name}`;
      const time = formatTimeAgo(dateOf(item));
      
      return `<div class="activity-item ${isNew ? 'new-glow' : ''}">
        <div class="activity-icon feedback">${icon}</div>
        <div class="activity-content">
          <div class="activity-title">${title}</div>
          <div class="activity-meta">${time}</div>
        </div>
      </div>`;
    }
  }).join('');
}

function renderEngagementStats(data) {
  const container = document.getElementById('engagementStats');
  if(!container) return;
  
  if(!data) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-light);font-size:12px;padding:20px">No engagement data</div>';
    return;
  }
  
  const stats = [
    { icon: 'üí¨', label: 'WhatsApp', value: data.whatsapp || 0, class: 'whatsapp' },
    { icon: 'üìû', label: 'Calls', value: data.call || 0, class: 'call' },
    { icon: '‚úâÔ∏è', label: 'Emails', value: data.email || 0, class: 'email' },
    { icon: 'üí¨', label: 'Chat', value: data.chat || 0, class: 'chat' }
  ];
  
  container.innerHTML = stats.map(s => `
    <div class="engagement-mini">
      <div class="engagement-mini-icon ${s.class}">${s.icon}</div>
      <div class="engagement-mini-content">
        <div class="engagement-mini-label">${s.label}</div>
        <div class="engagement-mini-value">${s.value}</div>
      </div>
    </div>
  `).join('');
}

function formatTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

let feedbackChartInstance = null;
let ratingChartInstance = null;
let monthlyRevenueChartInstance = null;
let revenueDistChartInstance = null;
let profitLossChartInstance = null;

function renderAnalyticsCharts() {
  // Feedback trend chart
  const monthlyData = {};
  [...rowsContacts, ...rowsFeedback].forEach(r => {
    const key = monthKey(dateOf(r));
    monthlyData[key] = (monthlyData[key] || 0) + 1;
  });
  
  // If no real data, use dummy data for demonstration
  let months, counts;
  if (Object.keys(monthlyData).length === 0) {
    // Dummy data for last 6 months
    const now = new Date();
    months = [];
    counts = [8, 12, 15, 18, 22, 25]; // Growing trend
    for (let i = 5; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push(d.toLocaleDateString('en', { month: 'short', year: '2-digit' }));
    }
  } else {
    months = Object.keys(monthlyData).sort().slice(-6);
    counts = months.map(m => monthlyData[m] || 0);
    months = months.map(m => {
      const [y, mo] = m.split('-');
      return new Date(y, mo - 1).toLocaleDateString('en', { month: 'short', year: '2-digit' });
    });
  }
  
  const feedbackCtx = document.getElementById('feedbackChart');
  if (feedbackCtx) {
    if (feedbackChartInstance) feedbackChartInstance.destroy();
    feedbackChartInstance = new Chart(feedbackCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Total Activity',
          data: counts,
          borderColor: '#8d6e63',
          backgroundColor: 'rgba(141, 110, 99, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.9)',
            padding: 12,
            cornerRadius: 6
          }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            ticks: { precision: 0, font: { size: 11 } },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            grid: { display: false },
            ticks: { font: { size: 11 } }
          }
        }
      }
    });
  }
  
  // Rating distribution
  const ratingDist = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
  rowsFeedback.forEach(r => {
    const stars = Number(r.stars) || 0;
    if (stars >= 1 && stars <= 5) ratingDist[stars]++;
  });
  
  // If no real data, use dummy data
  const hasRealData = Object.values(ratingDist).some(v => v > 0);
  if (!hasRealData) {
    ratingDist[5] = 45;
    ratingDist[4] = 28;
    ratingDist[3] = 12;
    ratingDist[2] = 8;
    ratingDist[1] = 7;
  }
  
  const ratingCtx = document.getElementById('ratingChart');
  if (ratingCtx) {
    if (ratingChartInstance) ratingChartInstance.destroy();
    ratingChartInstance = new Chart(ratingCtx, {
      type: 'doughnut',
      data: {
        labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
        datasets: [{
          data: [ratingDist[5], ratingDist[4], ratingDist[3], ratingDist[2], ratingDist[1]],
          backgroundColor: ['#8d6e63', '#a1887f', '#bcaaa4', '#d7ccc8', '#efebe9'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { 
            position: 'bottom', 
            labels: { 
              boxWidth: 12, 
              padding: 10, 
              font: { size: 11 } 
            } 
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.9)',
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: (context) => {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }
}

function currentRows() { return current === 'contacts' ? filteredContacts : filteredFeedback; }

function renderTable() {
  const rows = currentRows();
  const total = rows.length;
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = rows.slice(start, start + PAGE_SIZE);

  if(!rows.length) {
    q('tableWrap').innerHTML = `<div class="empty">No ${esc(current)} records found.</div>`;
    q('pagination').innerHTML = '';
    return;
  }

  const cols = Object.keys(rows[0]);
  q('tableWrap').innerHTML = `<table class="table"><thead><tr>${cols.map(c => `<th>${esc(c)}</th>`).join('')}</tr></thead><tbody>${pageRows.map(r => `<tr>${cols.map(c => `<td>${esc(r[c])}</td>`).join('')}</tr>`).join('')}</tbody></table>`;

  const totalPages = Math.ceil(total / PAGE_SIZE);
  let pagHtml = '';
  pagHtml += `<button type="button" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage-1}">Prev</button>`;
  pagHtml += `<span class="page-info">Page ${currentPage} of ${totalPages || 1} (${total} records)</span>`;
  pagHtml += `<button type="button" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage+1}">Next</button>`;
  q('pagination').innerHTML = pagHtml;
  q('pagination').querySelectorAll('button').forEach(b => {
    b.addEventListener('click', () => { currentPage = parseInt(b.dataset.page,10); renderTable(); });
  });
}



function exportCsv() {
  const rows = currentRows();
  if(!rows.length) return;
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `bmc-${current}-${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
}

function exportXlsx() {
  const rows = currentRows();
  if(!rows.length) return;
  const blob = new Blob([toCSV(rows)], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `bmc-${current}-${new Date().toISOString().slice(0,10)}.xlsx`;
  a.click(); URL.revokeObjectURL(a.href);
}

function exportPdf() {
  const rows = currentRows();
  if(!rows.length) return;
  const w = window.open('', '_blank');
  if(!w) return;
  w.document.write(`<html><head><title>BMC ${esc(current)}</title><meta charset="UTF-8"/></head><body><h2>BMC ${esc(current)}</h2><pre>${esc(JSON.stringify(rows,null,2))}</pre></body></html>`);
  w.document.close();
  w.print();
}

async function clearRecords() {
  if(current === 'contacts') {
    const cleared = await apiPost('/api/admin/leads/clear', {});
    if(!cleared.ok && (cleared.status === 401 || cleared.status === 403)) return logoutLocal();
  }
  await loadData();
}

async function logout() {
  await apiPost('/api/auth/logout', {});
  logoutLocal();
}

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    current = t.dataset.tab;
    currentPage = 1;
    renderTable();
    renderCharts();
  });
});

document.querySelectorAll('.sidebar-item').forEach(s => {
  s.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.sidebar-item').forEach(x => x.classList.remove('active'));
    s.classList.add('active');
    const nav = s.dataset.nav;
    if(nav === 'contacts') { document.querySelector('.tab[data-tab="contacts"]').click(); }
    else if(nav === 'feedback') { document.querySelector('.tab[data-tab="feedback"]').click(); }
    else if(nav === 'analytics') { document.querySelector('.tab[data-tab="feedback"]').click(); }
  });
});

q('searchInput').addEventListener('input', (e) => {
  searchQuery = e.target.value;
  applyFilter();
  renderTable();
});

q('exportCsv').addEventListener('click', exportCsv);
q('exportXlsx').addEventListener('click', exportXlsx);
q('exportPdf').addEventListener('click', exportPdf);
q('clearRecords').addEventListener('click', clearRecords);
q('logoutBtn').addEventListener('click', logout);

// Dark mode toggle
const darkModeBtn = q('darkModeToggle');
const isDarkMode = localStorage.getItem('bmc_dark_mode') === 'true';
if(isDarkMode) {
  document.body.classList.add('dark-mode');
  darkModeBtn.textContent = '‚òÄÔ∏è';
}
darkModeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('bmc_dark_mode', isDark);
  darkModeBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
});

loadData();
</script>
</body>
</html>
