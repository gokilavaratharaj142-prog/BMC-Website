<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - Best Marketing Company</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>window.API_BASE="http://localhost:5000";</script>
<style>
:root{--bg:#f9f5eb;--surface:#fff;--text:#3e2723;--text-light:#6d4c41;--accent:#8d6e63;--accent-dark:#4e342e;--border:rgba(62,39,35,.1)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);font-family:'Manrope',sans-serif;color:var(--text);min-height:100vh}

/* Layout */
.dash-wrap{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:20px 0;flex-shrink:0}
.sidebar-item{display:block;padding:12px 20px;color:var(--text);font-size:14px;font-weight:500;text-decoration:none;transition:background .2s}
.sidebar-item:hover{background:rgba(141,110,99,.08)}
.sidebar-item.active{background:rgba(141,110,99,.12);color:var(--accent-dark);border-left:3px solid var(--accent);margin-left:-3px;padding-left:23px}

.main{flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(62,39,35,.06)}
.topbar-left{font-size:16px;font-weight:600;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:16px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.ok{background:#1b6d2f}
.status-dot.bad{background:#b00020}
.status-text{font-size:12px;color:var(--text-light)}
.btn-out{font-size:13px;padding:8px 14px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;cursor:pointer;font-weight:500;transition:all .2s}
.btn-out:hover{background:rgba(62,39,35,.06)}

.content{padding:24px;flex:1}
.page-title{font-size:22px;font-weight:700;margin-bottom:4px;letter-spacing:-0.02em}
.page-desc{font-size:14px;color:var(--text-light);margin-bottom:24px}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04);transition:box-shadow .2s}
.card:hover{box-shadow:0 4px 12px rgba(62,39,35,.08)}
.card-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);font-weight:600;margin-bottom:6px}
.card-value{font-size:28px;font-weight:800;color:var(--accent-dark);line-height:1.1}

/* Tabs & Tools */
.tabs{display:flex;gap:8px;margin-bottom:16px}
.tab{padding:10px 18px;border:1px solid var(--border);border-radius:8px;background:var(--surface);cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.tab:hover{background:rgba(141,110,99,.06)}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.tools{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:center}
.search-wrap{flex:1;min-width:200px;max-width:320px}
.search-wrap input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--surface)}
.search-wrap input:focus{outline:none;border-color:var(--accent)}
.btn{padding:10px 16px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.btn:hover{background:var(--accent-dark);border-color:var(--accent-dark)}
.btn.secondary{background:transparent;color:var(--text);border-color:var(--border)}
.btn.secondary:hover{background:rgba(62,39,35,.06)}

/* Panel & Table */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 8px rgba(62,39,35,.04);overflow:hidden}
.table-wrap{overflow-x:auto}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th{background:rgba(62,39,35,.04);padding:12px 16px;text-align:left;font-weight:600;color:var(--text)}
.table td{padding:12px 16px;border-top:1px solid var(--border)}
.table tr:hover{background:rgba(141,110,99,.04)}
.empty{padding:32px;text-align:center;color:var(--text-light);font-size:14px}

/* Charts */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(62,39,35,.04)}
.chart-title{font-size:14px;font-weight:700;margin-bottom:16px;color:var(--text)}
.bar-chart{display:flex;flex-direction:column;gap:12px}
.bar-row{display:flex;align-items:center;gap:12px}
.bar-label{width:100px;font-size:12px;font-weight:500;color:var(--text-light)}
.bar-track{flex:1;height:8px;background:rgba(62,39,35,.08);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .3s}
.bar-val{width:36px;text-align:right;font-size:12px;font-weight:600;color:var(--text-light)}
.line-chart-svg{width:100%;height:120px}

/* Pagination */
.pagination{display:flex;gap:6px;align-items:center;margin-top:16px;flex-wrap:wrap}
.pagination button{padding:8px 12px;border:1px solid var(--border);background:var(--surface);border-radius:6px;cursor:pointer;font-size:13px;font-weight:500}
.pagination button:hover:not(:disabled){background:rgba(141,110,99,.08)}
.pagination button:disabled{opacity:0.5;cursor:not-allowed}
.pagination .page-info{font-size:13px;color:var(--text-light);margin-left:8px}

@media(max-width:1024px){.cards{grid-template-columns:1fr 1fr}.charts-row{grid-template-columns:1fr}}
@media(max-width:768px){.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border)}.dash-wrap{flex-direction:column}.cards{grid-template-columns:1fr}.tools{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<div class="dash-wrap">
  <aside class="sidebar">
    <a href="#" class="sidebar-item active" data-nav="dashboard">Dashboard</a>
    <a href="#" class="sidebar-item" data-nav="contacts">Contacts</a>
    <a href="#" class="sidebar-item" data-nav="feedback">Feedback</a>
    <a href="#" class="sidebar-item" data-nav="analytics">Analytics</a>
  </aside>
  <main class="main">
    <header class="topbar">
      <div class="topbar-left"><span id="adminName">Admin</span></div>
      <div class="topbar-right">
        <span class="status-text"><span id="statusDot" class="status-dot"></span><span id="backendStatus">Checking...</span></span>
        <button type="button" class="btn-out" id="logoutBtn">Logout</button>
      </div>
    </header>
    <div class="content">
      <h1 class="page-title">Dashboard</h1>
      <p class="page-desc" id="pageDesc">Overview of contacts and feedback</p>

      <div class="cards">
        <div class="card"><div class="card-label">Total Contacts</div><div class="card-value" id="stContacts">0</div></div>
        <div class="card"><div class="card-label">Total Feedback</div><div class="card-value" id="stFeedback">0</div></div>
        <div class="card"><div class="card-label">Monthly Growth %</div><div class="card-value" id="stGrowth">0%</div></div>
        <div class="card"><div class="card-label">Satisfaction %</div><div class="card-value" id="stSat">0%</div></div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="contacts" type="button">Contacts</button>
        <button class="tab" data-tab="feedback" type="button">Feedback</button>
      </div>

      <div class="tools">
        <div class="search-wrap"><input type="text" id="searchInput" placeholder="Search..." /></div>
        <button class="btn" id="exportCsv" type="button">Export CSV</button>
        <button class="btn" id="exportXlsx" type="button">Export Excel</button>
        <button class="btn" id="exportPdf" type="button">Export PDF</button>
        <button class="btn secondary" id="clearRecords" type="button">Clear Records</button>
      </div>

      <div class="panel">
        <div class="table-wrap" id="tableWrap"></div>
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="charts-row" id="chartsRow">
        <div class="chart-card"><div class="chart-title">Contacts per Month</div><div class="bar-chart" id="barChart"></div></div>
        <div class="chart-card"><div class="chart-title">Growth Trend</div><div id="lineChart"></div></div>
      </div>
    </div>
  </main>
</div>

<script>
const API_BASE = window.API_BASE || 'http://localhost:5000';
const TOKEN_KEY = 'bmc_jwt';
const AUTH_KEY = 'bmc_admin_auth';
const PAGE_SIZE = 10;

let current = 'contacts';
let rowsContacts = [];
let rowsFeedback = [];
let filteredContacts = [];
let filteredFeedback = [];
let currentPage = 1;
let searchQuery = '';

const q = (id) => document.getElementById(id);
const esc = (v) => String(v ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function logoutLocal() {
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(AUTH_KEY);
  window.location.href = 'admin.html';
}

function authHeaders() {
  const token = localStorage.getItem(TOKEN_KEY) || '';
  return token ? { Authorization: `Bearer ${token}` } : {};
}

async function apiGet(path) {
  const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders() }).catch(()=>null);
  if(!res) return { ok:false, status:0, data:null };
  const data = await res.json().catch(()=>null);
  return { ok: res.ok, status: res.status, data };
}

async function apiPost(path, body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeaders() },
    body: JSON.stringify(body || {})
  }).catch(()=>null);
  if(!res) return { ok:false, status:0, data:null };
  const data = await res.json().catch(()=>null);
  return { ok: res.ok, status: res.status, data };
}

function toCSV(rows) {
  if(!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const e = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;
  return [cols.join(',')].concat(rows.map(r => cols.map(c => e(r[c])).join(','))).join('\r\n');
}

function dateOf(row) { return new Date(row.createdAt || row.timestamp || Date.now()); }
function monthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

function filterRows(rows, q) {
  if(!q.trim()) return rows;
  const lower = q.toLowerCase();
  return rows.filter(r => Object.values(r).some(v => String(v ?? '').toLowerCase().includes(lower)));
}

function isTokenExpired() {
  const token = localStorage.getItem(TOKEN_KEY);
  if(!token) return true;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.exp && payload.exp * 1000 < Date.now();
  } catch(_){ return true; }
}

async function loadData() {
  const token = localStorage.getItem(TOKEN_KEY);
  const authed = localStorage.getItem(AUTH_KEY) === 'yes';
  if(!token || !authed || isTokenExpired()) return logoutLocal();

  const statusEl = q('backendStatus');
  const dotEl = q('statusDot');
  const overview = await apiGet('/api/admin/overview');
  if(!overview.ok) {
    statusEl.textContent = 'Offline';
    dotEl.className = 'status-dot bad';
    if(overview.status === 401 || overview.status === 403) return logoutLocal();
  } else {
    statusEl.textContent = 'Online';
    dotEl.className = 'status-dot ok';
  }

  const leads = await apiGet('/api/admin/leads');
  const feedback = await apiGet('/api/feedback');

  rowsContacts = (leads.ok && Array.isArray(leads.data)) ? leads.data : [];
  rowsFeedback = (feedback.ok && Array.isArray(feedback.data)) ? feedback.data : [];

  applyFilter();
  renderStats();
  renderTable();
  renderCharts();
}

function applyFilter() {
  filteredContacts = filterRows(rowsContacts, searchQuery);
  filteredFeedback = filterRows(rowsFeedback, searchQuery);
  currentPage = 1;
}

function renderStats() {
  q('stContacts').textContent = rowsContacts.length;
  q('stFeedback').textContent = rowsFeedback.length;

  const now = new Date();
  const curr = monthKey(now);
  const prev = monthKey(new Date(now.getFullYear(), now.getMonth() - 1, 1));
  const currCount = rowsContacts.filter(r => monthKey(dateOf(r)) === curr).length + rowsFeedback.filter(r => monthKey(dateOf(r)) === curr).length;
  const prevCount = rowsContacts.filter(r => monthKey(dateOf(r)) === prev).length + rowsFeedback.filter(r => monthKey(dateOf(r)) === prev).length;
  const growth = prevCount ? Math.round(((currCount - prevCount) / prevCount) * 100) : (currCount ? 100 : 0);
  q('stGrowth').textContent = `${growth}%`;

  const good = rowsFeedback.filter(r => {
    const rating = String(r.rating || '');
    const stars = Number(r.stars || r.rating || 0);
    return rating.startsWith('5') || rating.startsWith('4') || stars >= 4 || ['love','like','happy'].includes(String(r.sentiment || '').toLowerCase());
  }).length;
  q('stSat').textContent = `${rowsFeedback.length ? Math.round((good / rowsFeedback.length) * 100) : 0}%`;
}

function currentRows() { return current === 'contacts' ? filteredContacts : filteredFeedback; }

function renderTable() {
  const rows = currentRows();
  const total = rows.length;
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = rows.slice(start, start + PAGE_SIZE);

  if(!rows.length) {
    q('tableWrap').innerHTML = `<div class="empty">No ${esc(current)} records found.</div>`;
    q('pagination').innerHTML = '';
    return;
  }

  const cols = Object.keys(rows[0]);
  q('tableWrap').innerHTML = `<table class="table"><thead><tr>${cols.map(c => `<th>${esc(c)}</th>`).join('')}</tr></thead><tbody>${pageRows.map(r => `<tr>${cols.map(c => `<td>${esc(r[c])}</td>`).join('')}</tr>`).join('')}</tbody></table>`;

  const totalPages = Math.ceil(total / PAGE_SIZE);
  let pagHtml = '';
  pagHtml += `<button type="button" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage-1}">Prev</button>`;
  pagHtml += `<span class="page-info">Page ${currentPage} of ${totalPages || 1} (${total} records)</span>`;
  pagHtml += `<button type="button" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage+1}">Next</button>`;
  q('pagination').innerHTML = pagHtml;
  q('pagination').querySelectorAll('button').forEach(b => {
    b.addEventListener('click', () => { currentPage = parseInt(b.dataset.page,10); renderTable(); });
  });
}

function renderCharts() {
  const byMonth = {};
  [...rowsContacts, ...rowsFeedback].forEach(r => {
    const k = monthKey(dateOf(r));
    byMonth[k] = (byMonth[k] || 0) + 1;
  });
  const sortedMonths = Object.keys(byMonth).sort();
  const maxBar = Math.max(1, ...Object.values(byMonth));

  q('barChart').innerHTML = sortedMonths.slice(-6).map(m => {
    const v = byMonth[m] || 0;
    const pct = Math.round((v / maxBar) * 100);
    return `<div class="bar-row"><span class="bar-label">${esc(m)}</span><div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div><span class="bar-val">${v}</span></div>`;
  }).join('') || '<div class="empty">No data</div>';

  const trendData = sortedMonths.slice(-7).map(m => byMonth[m] || 0);
  const maxLine = Math.max(1, ...trendData);
  const w = 300; const h = 100;
  let path = '';
  trendData.forEach((v, i) => {
    const x = (i / (trendData.length - 1 || 1)) * (w - 20) + 10;
    const y = h - 20 - (v / maxLine) * (h - 40);
    path += (i === 0 ? 'M' : 'L') + x + ',' + y;
  });
  q('lineChart').innerHTML = trendData.length ? `<svg class="line-chart-svg" viewBox="0 0 ${w} ${h}"><path d="${path}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>` : '<div class="empty">No data</div>';
}

function exportCsv() {
  const rows = currentRows();
  if(!rows.length) return;
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `bmc-${current}-${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
}

function exportXlsx() {
  const rows = currentRows();
  if(!rows.length) return;
  const blob = new Blob([toCSV(rows)], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `bmc-${current}-${new Date().toISOString().slice(0,10)}.xlsx`;
  a.click(); URL.revokeObjectURL(a.href);
}

function exportPdf() {
  const rows = currentRows();
  if(!rows.length) return;
  const w = window.open('', '_blank');
  if(!w) return;
  w.document.write(`<html><head><title>BMC ${esc(current)}</title><meta charset="UTF-8"/></head><body><h2>BMC ${esc(current)}</h2><pre>${esc(JSON.stringify(rows,null,2))}</pre></body></html>`);
  w.document.close();
  w.print();
}

async function clearRecords() {
  if(current === 'contacts') {
    const cleared = await apiPost('/api/admin/leads/clear', {});
    if(!cleared.ok && (cleared.status === 401 || cleared.status === 403)) return logoutLocal();
  }
  await loadData();
}

async function logout() {
  await apiPost('/api/auth/logout', {});
  logoutLocal();
}

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    current = t.dataset.tab;
    currentPage = 1;
    renderTable();
    renderCharts();
  });
});

document.querySelectorAll('.sidebar-item').forEach(s => {
  s.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.sidebar-item').forEach(x => x.classList.remove('active'));
    s.classList.add('active');
    const nav = s.dataset.nav;
    if(nav === 'contacts') { document.querySelector('.tab[data-tab="contacts"]').click(); }
    else if(nav === 'feedback') { document.querySelector('.tab[data-tab="feedback"]').click(); }
    else if(nav === 'analytics') { document.querySelector('.tab[data-tab="feedback"]').click(); }
  });
});

q('searchInput').addEventListener('input', (e) => {
  searchQuery = e.target.value;
  applyFilter();
  renderTable();
});

q('exportCsv').addEventListener('click', exportCsv);
q('exportXlsx').addEventListener('click', exportXlsx);
q('exportPdf').addEventListener('click', exportPdf);
q('clearRecords').addEventListener('click', clearRecords);
q('logoutBtn').addEventListener('click', logout);

loadData();
</script>
</body>
</html>
